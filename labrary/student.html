<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="icon" type="image/png" href="img/logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ - IT Library</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="student-page">

<!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ù„Ù„Ø·Ø§Ù„Ø¨ -->
<header class="student-navbar">
    <div class="container">
        <div class="student-info">
            <div class="student-avatar">
                <i class="fas fa-user-graduate"></i>
            </div>
            <div class="student-details">
                <h1 id="studentName">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</h1>
                <span class="student-stage" id="studentStage">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</span>
            </div>
        </div>
        
        <nav class="student-nav">
            <a href="student.html" class="student-nav-link active">
                <i class="fas fa-home"></i> Ø§Ù„Ù…ÙˆØ§Ø¯
            </a>
            <a href="#resources" class="student-nav-link">
                <i class="fas fa-folder-open"></i> Ø§Ù„Ù…ØµØ§Ø¯Ø±
            </a>
            <a href="index.html" class="student-nav-link logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            </a>
        </nav>
    </div>
</header>

<main class="student-main">
    <div class="container">
        
        <!-- Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø© -->
        <section class="student-section">
            <h2 class="student-section-title">
                <i class="fas fa-book"></i> Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø© <span id="currentStudentStage">Ø§Ù„Ø£ÙˆÙ„Ù‰</span>
            </h2>
            
            <div class="student-subjects-grid" id="studentSubjectsGrid">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
            </div>
        </section>
        
        <!-- Ø§Ù„Ù…ØµØ§Ø¯Ø± -->
        <section id="resources" class="student-section">
            <h2 class="student-section-title">
                <i class="fas fa-folder-open"></i> Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©
            </h2>
            
            <div class="resources-filter">
                <div class="filter-group">
                    <label for="studentSubjectFilter"><i class="fas fa-filter"></i> ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
                    <select id="studentSubjectFilter">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</option>
                        <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="resourceTypeFilter"><i class="fas fa-filter"></i> ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹:</label>
                    <select id="resourceTypeFilter">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                        <option value="pdf">PDF</option>
                        <option value="docx">Word</option>
                        <option value="ppt">Ø¹Ø±ÙˆØ¶ ØªÙ‚Ø¯ÙŠÙ…ÙŠØ©</option>
                    </select>
                </div>
            </div>
            
            <div class="student-resources-grid" id="studentResourcesGrid">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
            </div>
        </section>
    </div>
</main>

<script src="js/main.js"></script>

<script>
    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
    document.addEventListener('DOMContentLoaded', async function() {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        
        if (!currentUser) {
            window.location.href = 'index.html';
            return;
        }
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¯Ù…Ù†ØŒ ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
        if (currentUser.stage === 'admin') {
            window.location.href = 'admin.html';
            return;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
        document.getElementById('studentName').textContent = currentUser.fullName;
        const stageNames = { '1': 'Ø§Ù„Ø£ÙˆÙ„Ù‰', '2': 'Ø§Ù„Ø«Ø§Ù†ÙŠØ©', '3': 'Ø§Ù„Ø«Ø§Ù„Ø«Ø©', '4': 'Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©' };
        document.getElementById('studentStage').textContent = `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${stageNames[currentUser.stage]}`;
        document.getElementById('currentStudentStage').textContent = stageNames[currentUser.stage];
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ù…ØµØ§Ø¯Ø± Ù…Ù† Ù…Ù„ÙØ§Øª JSON
        await loadStudentData(currentUser.stage);
    });
    
    async function loadStudentData(stage) {
        try {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ù† Ù…Ù„Ù JSON
            const subjectsResponse = await fetch('data/subjects.json');
            const subjects = await subjectsResponse.json();
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ù…Ù† Ù…Ù„Ù JSON
            const resourcesResponse = await fetch('data/resources.json');
            const resources = await resourcesResponse.json();
            
            // ØªØµÙÙŠØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
            const stageSubjects = subjects.filter(subject => subject.stage === stage);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯
            displayStudentSubjects(stageSubjects, subjects);
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ§Ø¯Ø±
            displayStudentResources(resources, stageSubjects);
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            // Ø§Ø³ØªØ®Ø¯Ù… localStorage ÙƒØ¨Ø¯ÙŠÙ„
            const subjects = JSON.parse(localStorage.getItem('itlibrary_subjects') || '[]');
            const resources = JSON.parse(localStorage.getItem('itlibrary_resources') || '[]');
            
            const stageSubjects = subjects.filter(subject => subject.stage === stage);
            displayStudentSubjects(stageSubjects, subjects);
            displayStudentResources(resources, stageSubjects);
        }
    }
    
    async function displayStudentSubjects(subjects, allSubjects = null) {
        const grid = document.getElementById('studentSubjectsGrid');
        const filter = document.getElementById('studentSubjectFilter');
        
        if (!grid) return;
        
        grid.innerHTML = '';
        filter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</option>';
        
        subjects.forEach(subject => {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ù„Ù…ØµÙÙˆÙØ©
            const subjectCard = document.createElement('div');
            subjectCard.className = 'subject-card';
            subjectCard.innerHTML = `
                <div class="subject-card-header">
                    <h3>${subject.id}</h3>
                    <span class="subject-type">Ù…Ø§Ø¯Ø©</span>
                </div>
                <div class="subject-card-body">
                    <h4>${subject.name}</h4>
                    <p>${subject.description}</p>
                    <p class="resource-count">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ§Ø¯Ø±: ${subject.resourcesCount || 0}</p>
                </div>
                <div class="subject-card-footer">
                    <button class="btn-view-subject" onclick="filterBySubject('${subject.id}')">
                        <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ§Ø¯Ø±
                    </button>
                </div>
            `;
            grid.appendChild(subjectCard);
            
            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙÙ„ØªØ±
            const option = document.createElement('option');
            option.value = subject.id;
            option.textContent = `${subject.id} - ${subject.name}`;
            filter.appendChild(option);
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ù„ÙÙ„ØªØ±
        filter.addEventListener('change', async function() {
            const selectedSubject = this.value;
            
            try {
                const resourcesResponse = await fetch('data/resources.json');
                const resources = await resourcesResponse.json();
                const subjectsResponse = await fetch('data/subjects.json');
                const subjects = await subjectsResponse.json();
                
                let filteredResources = resources;
                if (selectedSubject) {
                    filteredResources = resources.filter(resource => resource.subjectId === selectedSubject);
                }
                
                displayStudentResources(filteredResources, subjects);
            } catch (error) {
                // Ø§Ø³ØªØ®Ø¯Ù… localStorage ÙƒØ¨Ø¯ÙŠÙ„
                const resources = JSON.parse(localStorage.getItem('itlibrary_resources') || '[]');
                const subjects = JSON.parse(localStorage.getItem('itlibrary_subjects') || '[]');
                let filteredResources = resources;
                if (selectedSubject) {
                    filteredResources = resources.filter(resource => resource.subjectId === selectedSubject);
                }
                displayStudentResources(filteredResources, subjects);
            }
        });
    }
    
    async function displayStudentResources(resources, subjects) {
        const grid = document.getElementById('studentResourcesGrid');
        if (!grid) return;
        
        grid.innerHTML = '';
        
        // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø­Ø¯Ø¯
        const typeFilter = document.getElementById('resourceTypeFilter');
        let filteredResources = resources;
        
        if (typeFilter && typeFilter.value) {
            filteredResources = resources.filter(resource => resource.type === typeFilter.value);
        }
        
        filteredResources.forEach(resource => {
            const subject = subjects.find(s => s.id === resource.subjectId);
            if (!subject) return;
            
            const resourceCard = document.createElement('div');
            resourceCard.className = 'resource-card';
            
            let typeIcon = 'fa-file';
            let typeClass = '';
            if (resource.type === 'pdf') {
                typeIcon = 'fa-file-pdf';
                typeClass = 'pdf';
            } else if (resource.type === 'docx') {
                typeIcon = 'fa-file-word';
                typeClass = 'doc';
            } else if (resource.type === 'ppt') {
                typeIcon = 'fa-file-powerpoint';
                typeClass = 'ppt';
            }
            
            resourceCard.innerHTML = `
                <div class="resource-card-header ${typeClass}">
                    <i class="fas ${typeIcon}"></i>
                    <span class="resource-type">${resource.type?.toUpperCase() || 'Ù…Ù„Ù'}</span>
                </div>
                <div class="resource-card-body">
                    <h4>${resource.title}</h4>
                    <p class="resource-subject"><i class="fas fa-book"></i> ${subject.name}</p>
                    <p class="resource-description">${resource.description}</p>
                    <p class="resource-meta">
                        <small><i class="far fa-calendar"></i> ${resource.uploadDate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} | <i class="fas fa-weight"></i> ${resource.size || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</small>
                    </p>
                </div>
                <div class="resource-card-footer">
                    <a href="${resource.url || '#'}" class="btn-download" download="${resource.title}">
                        <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„
                    </a>
                </div>
            `;
            grid.appendChild(resourceCard);
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ù„ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
        if (typeFilter) {
            typeFilter.addEventListener('change', async function() {
                try {
                    const resourcesResponse = await fetch('data/resources.json');
                    const resources = await resourcesResponse.json();
                    const subjectsResponse = await fetch('data/subjects.json');
                    const subjects = await subjectsResponse.json();
                    displayStudentResources(resources, subjects);
                } catch (error) {
                    const resources = JSON.parse(localStorage.getItem('itlibrary_resources') || '[]');
                    const subjects = JSON.parse(localStorage.getItem('itlibrary_subjects') || '[]');
                    displayStudentResources(resources, subjects);
                }
            });
        }
    }
    
    function filterBySubject(subjectId) {
        const filter = document.getElementById('studentSubjectFilter');
        filter.value = subjectId;
        filter.dispatchEvent(new Event('change'));
        
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ§Ø¯Ø±
        document.getElementById('resources').scrollIntoView({ behavior: 'smooth' });
    }
</script>
<!-- Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù†Ø´Ø± -->
<div class="copyright">
    <p>Â© 2023 IT Library. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
    <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© - Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</p>
    <p>Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø®ØµÙŠ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ ÙÙ‚Ø·</p>
</div>
<!-- Ø²Ø± Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù… -->
<button id="chatButton" onclick="toggleChat()" 
        style="position: fixed; bottom: 20px; right: 20px; 
               width: 60px; height: 60px; border-radius: 50%; 
               background: linear-gradient(135deg, #667eea, #764ba2); 
               color: white; border: none; font-size: 24px; 
               cursor: pointer; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
               display: flex; align-items: center; justify-content: center;
               transition: transform 0.3s;">
    ğŸ¤–  <!-- Ø±ÙˆØ¨ÙˆØª Ø¨Ø¯Ù„ Ù…Ø­Ø§Ø¯Ø«Ø© -->
</button>
<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø§Øª -->
<div id="chatWindow" 
     style="display: none; position: fixed; bottom: 90px; right: 20px; 
            width: 350px; height: 500px; background: white; 
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            z-index: 1001; overflow: hidden; flex-direction: column;">
    
    <!-- Ø±Ø£Ø³ Ø§Ù„Ø´Ø§Øª -->
    <div style="background: linear-gradient(135deg, #2c3e50, #3498db); 
                color: white; padding: 15px; display: flex; 
                justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 20px;">ğŸ¤–</span>
            <span style="font-weight: bold;">Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…ÙƒØªØ¨Ø©</span>
        </div>
        <button onclick="toggleChat()" 
                style="background: none; border: none; color: white; 
                       font-size: 20px; cursor: pointer;">Ã—</button>
    </div>
    
    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
    <div id="chatMessages" 
         style="flex: 1; overflow-y: auto; padding: 15px; background: #f8f9fa;">
        <div style="background: white; padding: 12px 15px; border-radius: 10px; 
                    margin-bottom: 10px; border: 1px solid #e0e0e0;">
            <strong>ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…ÙƒØªØ¨Ø©:</strong> Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ. 
            Ø£Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø§Ù„Ù…ÙˆØ§Ø¯ Ø£Ùˆ Ø§Ù„Ù…ØµØ§Ø¯Ø±.
        </div>
    </div>
    
    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
    <div style="padding: 15px; border-top: 1px solid #e9ecef; background: white;">
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="chatInput" 
                   placeholder="Ø§Ø³Ø£Ù„ Ø¹Ù† Ù…Ø§Ø¯Ø© Ø£Ùˆ Ù…ØµØ¯Ø±..." 
                   style="flex: 1; padding: 12px 15px; border: 2px solid #ddd; 
                          border-radius: 25px; outline: none; font-size: 14px;">
            <button onclick="sendChatMessage()" 
                    style="background: linear-gradient(135deg, #2ecc71, #27ae60); 
                           color: white; border: none; width: 50px; 
                           border-radius: 50%; cursor: pointer; font-size: 18px;">
                â¤
            </button>
        </div>
        
        <!-- Ø£Ø³Ø¦Ù„Ø© Ø³Ø±ÙŠØ¹Ø© -->
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <button onclick="quickQuestion('Ù…Ø§ Ù‡ÙŠ Ù…Ø§Ø¯Ø© IT101ØŸ')" 
                    style="font-size: 12px; padding: 6px 12px; 
                           border: 1px solid #3498db; border-radius: 15px; 
                           background: white; color: #3498db; cursor: pointer;">
                Ù…Ø§ Ù‡ÙŠ IT101ØŸ
            </button>
            <button onclick="quickQuestion('ÙˆÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ø±ØŸ')" 
                    style="font-size: 12px; padding: 6px 12px; 
                           border: 1px solid #3498db; border-radius: 15px; 
                           background: white; color: #3498db; cursor: pointer;">
                ÙˆÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ø±ØŸ
            </button>
            <button onclick="quickQuestion('Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ø¯Ø±Ø§Ø³Ø©')" 
                    style="font-size: 12px; padding: 6px 12px; 
                           border: 1px solid #3498db; border-radius: 15px; 
                           background: white; color: #3498db; cursor: pointer;">
                Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ø¯Ø±Ø§Ø³Ø©
            </button>
        </div>
    </div>
</div>
<script>
// Ù…ÙØªØ§Ø­ OpenRouter API
const OPENROUTER_API_KEY = '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';

// ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø§Øª
function toggleChat() {
    const chatWindow = document.getElementById('chatWindow');
    const chatButton = document.getElementById('chatButton');
    
    if (chatWindow.style.display === 'flex') {
        chatWindow.style.display = 'none';
        chatButton.innerHTML = 'ğŸ’¬';
    } else {
        chatWindow.style.display = 'flex';
        chatButton.innerHTML = 'âœ•';
        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        setTimeout(() => document.getElementById('chatInput').focus(), 100);
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©
function addChatMessage(text, isUser = false) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    
    messageDiv.style.cssText = `
        background: ${isUser ? '#e3f2fd' : 'white'};
        padding: 12px 15px;
        border-radius: 10px;
        margin-bottom: 10px;
        border: 1px solid ${isUser ? '#bbdefb' : '#e0e0e0'};
        margin-left: ${isUser ? '20px' : '0'};
        margin-right: ${isUser ? '0' : '20px'};
        word-wrap: break-word;
    `;
    
    messageDiv.innerHTML = `
        <strong>${isUser ? 'ğŸ‘¤ Ø£Ù†Øª' : 'ğŸ¤– Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯'}:</strong> 
        ${text.replace(/\n/g, '<br>')}
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± "Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø©"
function showTyping() {
    const chatMessages = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typingIndicator';
    typingDiv.style.cssText = `
        background: white;
        padding: 12px 15px;
        border-radius: 10px;
        margin-bottom: 10px;
        border: 1px solid #e0e0e0;
        margin-right: 20px;
        color: #666;
        font-style: italic;
        display: flex;
        align-items: center;
        gap: 10px;
    `;
    typingDiv.innerHTML = `
        <div>ğŸ¤– Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙŠÙƒØªØ¨...</div>
        <div style="display: flex; gap: 3px;">
            <div style="width: 8px; height: 8px; background: #3498db; border-radius: 50%; 
                       animation: bounce 1.4s infinite;"></div>
            <div style="width: 8px; height: 8px; background: #3498db; border-radius: 50%; 
                       animation: bounce 1.4s infinite; animation-delay: 0.2s;"></div>
            <div style="width: 8px; height: 8px; background: #3498db; border-radius: 50%; 
                       animation: bounce 1.4s infinite; animation-delay: 0.4s;"></div>
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
function hideTyping() {
    const typingDiv = document.getElementById('typingIndicator');
    if (typingDiv) typingDiv.remove();
}

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) {
        alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø³Ø¤Ø§Ù„ Ø£ÙˆÙ„Ø§Ù‹');
        return;
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    addChatMessage(message, true);
    input.value = '';
    
    // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
    showTyping();
    
    try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const stage = currentUser ? currentUser.stage : '1';
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø©
        const systemMessage = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ù…ÙƒØªØ¨Ø© ØªÙ‚Ù†ÙŠØ© ÙÙŠ Ø¬Ø§Ù…Ø¹Ø©.
        Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠØ¯Ø±Ø³ ÙÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${stage}.
        Ø§Ù„Ù…ÙƒØªØ¨Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¯ ØªÙ‚Ù†ÙŠØ© Ù…Ø«Ù„:
        - IT101: Ù…Ù‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©
        - IT102: Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„Ù…Ù†ÙØµÙ„Ø©
        - IT201: Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„ÙˆÙŠØ¨
        - IT301: Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
        
        Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ:
        1. Ø´Ø±Ø­ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©
        2. ØªÙˆØ¬ÙŠÙ‡Ù‡ Ù„Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
        3. ØªÙ‚Ø¯ÙŠÙ… Ù†ØµØ§Ø¦Ø­ Ø¯Ø±Ø§Ø³ÙŠØ©
        4. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© ØªÙ‚Ù†ÙŠØ©
        
        ØªØ­Ø¯Ø« Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰. ÙƒÙ† Ù…ÙÙŠØ¯Ø§Ù‹ ÙˆØ¯ÙˆØ¯Ø§Ù‹.`;
        
        // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ OpenRouter API
        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json',
                'HTTP-Referer': window.location.origin,
                'X-Title': 'IT Library Assistant'
            },
            body: JSON.stringify({
                model: 'openai/gpt-3.5-turbo',
                messages: [
                    {
                        role: 'system',
                        content: systemMessage
                    },
                    {
                        role: 'user',
                        content: message
                    }
                ],
                max_tokens: 500,
                temperature: 0.7
            })
        });
        
        // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
        hideTyping();
        
        if (!response.ok) {
            throw new Error(`Ø®Ø·Ø£: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.choices && data.choices[0] && data.choices[0].message) {
            addChatMessage(data.choices[0].message.content, false);
        } else {
            addChatMessage('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø±Ø¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', false);
        }
        
    } catch (error) {
        hideTyping();
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø§Øª:', error);
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø¯ Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        const fallbackResponses = {
            'Ù…Ø±Ø­Ø¨Ø§': 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ',
            'ÙˆÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ø±': 'Ø§Ù„Ù…ØµØ§Ø¯Ø± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ ØµÙØ­Ø© "Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©"',
            'Ù…Ø§ Ù‡ÙŠ it101': 'IT101 Ù‡ÙŠ Ù…Ø§Ø¯Ø© Ù…Ù‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Python',
            'Ø´ÙƒØ±Ø§': 'Ø§Ù„Ø¹ÙÙˆ! Ø³Ø¹ÙŠØ¯ Ø¨Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ.',
            'Ù†ØµØ§Ø¦Ø­': 'â€¢ Ù†Ø¸Ù… ÙˆÙ‚ØªÙƒ â€¢ ØªØ¯Ø±Ø¨ Ø¹Ù…Ù„ÙŠØ§Ù‹ â€¢ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø© â€¢ Ø§Ø³Ø£Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³'
        };
        
        let fallbackAnswer = 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        for (const [key, value] of Object.entries(fallbackResponses)) {
            if (message.toLowerCase().includes(key.toLowerCase())) {
                fallbackAnswer = value;
                break;
            }
        }
        
        addChatMessage(fallbackAnswer, false);
    }
}

// Ø£Ø³Ø¦Ù„Ø© Ø³Ø±ÙŠØ¹Ø©
function quickQuestion(question) {
    document.getElementById('chatInput').value = question;
    sendChatMessage();
}

// Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendChatMessage();
    }
});

// Ø¥Ø¶Ø§ÙØ© Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ù„Ù†Ù‚Ø§Ø·
const style = document.createElement('style');
style.textContent = `
    @keyframes bounce {
        0%, 100% { transform: translateY(0); opacity: 0.6; }
        50% { transform: translateY(-5px); opacity: 1; }
    }
`;
document.head.appendChild(style);

// ÙØªØ­ Ø§Ù„Ø´Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø£ÙˆÙ„ Ù…Ø±Ø© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
window.addEventListener('load', function() {
    setTimeout(() => {
        if (!localStorage.getItem('chatOpened')) {
            toggleChat();
            localStorage.setItem('chatOpened', 'true');
        }
    }, 5000);
});
</script>
</body>

</html>
